#include <EEPROM.h>

#define nivel A0 //sensor de niveljsn-sr04t
#define chuva A2 //sensor de chuva
#define umidade1 A3 //sensor de umidade HL69
#define umidade2 A6 //sensor de umidade HL69

//guardaremos 4 ints e um bool (se regou ou não) - 5 bytes no total

int len = EEPROM.length();

int eeprom_alvo = 1;

bool regou = 0; //se regou ou não


//os primeiros endereços da EEPROM serão para definir onde será escrito
//isso para caso ocorra perda de energia podemos revisitar este endereço
void setup() {
  //caso realmente seja a primeira vez precisamor forçar a EEPROM enderço 0 a ser 1
  Serial.begin(115200);
  
  pinMode(nivel, INPUT);
  pinMode(chuva, INPUT);
  pinMode(umidade1, INPUT);
  pinMode(umidade2, INPUT);

  EEPROM.update(0, 1);//lugar e valor forçado, DEVE SER REMOVIDO NO CÓDIGO FINAL
}

void checa_alvo(){
  //verifica e guarda em variavel, aponta pro proximo valor livre
  eeprom_alvo = EEPROM.read(0);
}

void incrementa_alvo(){
  //incrementa pra proxima interação
  EEPROM.update(0, eeprom_alvo + 5);//lugar e tamanho do set de infos
}


void guarda_eeprom(){
  
  EEPROM.update(eeprom_alvo, analogRead(nivel)/4); //depende de como e quantos bits tem o nível
  EEPROM.update(eeprom_alvo + 1, analogRead(chuva)/4); //divide por quatro pois a EEPROM trabalha com menos bits
  EEPROM.update(eeprom_alvo + 2, analogRead(umidade1)/4);
  EEPROM.update(eeprom_alvo + 3, analogRead(umidade2 )/4);

  EEPROM.update(eeprom_alvo + 4, analogRead(regou)/4); //se regou ou não
  
  
}

//EEPROM só guarda até 255, então precisa dividir os analogs por 4
//Temos 1024 pra usar
void loop() {
  checa_alvo();
  //Serial.print("Valor alvo da eeprom:");
  //Serial.print(eeprom_alvo, DEC);
  //Serial.println();
  //Serial.print("Valor do potenciômetro ");
  //Serial.print(analogRead(potent),DEC);
  //Serial.println();

  guarda_eeprom();

  //Serial.print("Valor guardado na EEPROM:");
  //Serial.print(EEPROM.read(eeprom_alvo),DEC);
  //Serial.println();

  incrementa_alvo();
  delay(4000);

}

//uma tecnica pode ser: fazer o update do endereço 0 a cada 10 ou 20 mudanças, prolongando a vida da EEPROM
